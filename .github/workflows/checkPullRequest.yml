name: Check Pull Request

on:
  pull_request:
    types: [assigned, opened, synchronize, reopened]
    branches-ignore: [main]

jobs:
  getOrCreatePullRequest:
    name: Get Pull Reqest Dev and Release, create if not exist
    runs-on: ubuntu-latest
    outputs:
      pullRequestDev: ${{ steps.getPullRequestDev.outputs.pullRequestDev }}
      pullRequestRelease: ${{ steps.getPullRequestRelease.outputs.pullRequestRelease }}
    steps:
      - name: Get pull request dev details
        id: getPullRequestDev
        uses: actions/github-script@v5
        with:
          script: |
            console.log('repo dev details', context)
            return {
              ...context.payload.pull_request,
            }

      - name: Get pull request release details
        id: getPullRequestRelease
        uses: actions/github-script@v5
        with:
          script: |
            console.log('repo release details', context)
            const variableList = {
              owner: context.actor,
              repo: context.repo.repo,
              state: 'open',
              base: 'main',
            }
            console.log('variableList', variableList)
            const pullRequestReleases = await github.rest.pulls.list(variableList)
            console.log('pullRequestReleases', pullRequestReleases)
            return pullRequestReleases.data

      - uses: actions/checkout@v2
      - name: Set username
        run: |
          git config user.name 'Robby Putra'
          git config user.email 'robbycp@users.noreply.github.com'
      - name: Create pull request release
        id: createPullRequestRelease
        if: ${{ steps.getPullRequestRelease.outputs[0] == null }}
        uses: actions/github-script@v5
        with:
          script: |
            // Check if there is no changes between branch staging and main
            const repoMainData = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main',
            })
            const repoStagingData = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'staging',
            })
            console.log('repoMainData', repoMainData)
            console.log('repoStagingData', repoStagingData)
            if (repoMainData.data.commit.sha === repoStagingData.data.commit.sha) {
              return {
                isMainAndStagingSame: true
              }
            }

            const today = new Date().toDateString()
            const createdPR = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'staging',
              base: 'main',
              title: `Release ${today}`,
              body: `
                ## Fix:
                ## Feature:
                ## Modify:
                ## Breaking:
              `
            })
            console.log('createdPR', createdPR)
            return createdPR

  checkPullRequestDev:
    name: Check Pull Request Dev
    needs: ['getOrCreatePullRequest']
    runs-on: ubuntu-latest
    steps:
      - name: Check pull request dev label
        if: ${{ !contains(fromJSON('["QAPassed"]'), steps.getPullRequestDev.outputs.pr_labels) }}
        run: exit 1

      - name: Check pull request dev title
        uses: actions/github-script@v5
        with:
          script: |
            console.log('check PR dev context', context)
            console.log('${{ needs }}')
            # console.log('needs.getPullRequestDev', needs.getPullRequestDev)
            # const prefix = needs.getPullRequestDev.outputs.title.split('-')[0]
            # if (!['fix', 'modify', 'feature', 'breaking'].includes(prefix)) {
            #   core.setFailed('Prefix title should be fix | modify | feature | breaking')
            # }

  checkPullRequestRelease:
    name: Check Pull Request Release
    needs: ['getOrCreatePullRequest']
    runs-on: ubuntu-latest
    steps:
      - name: Check pull request release label
        uses: actions/github-script@v5
        env:
          NEEDS: '${{needs}}'
        with:
          script: |
            console.log('check PR release context', context)
            console.log('NEEDS', process.env.NEEDS)
            # console.log('needs.getPullRequestRelease', needs.getPullRequestRelease)
            # if (needs.getPullRequestRelease.labels.includes('lockDeploys')) {
            #   core.setFailed('Pull Request release has label lockDeploys')
            # }
